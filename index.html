<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Dolní Lhota Run</title>
  <!-- 1) Načtení Firebase knihoven -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- 2) Váš aplikační kód -->
  <script>
    // Konfigurace Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDHGzESwHUmmyy0_txyWL7VCp7eWFmtE9w",
      authDomain: "run-challange.firebaseapp.com",
      projectId: "run-challange",
      storageBucket: "run-challange.firebasestorage.app",
      messagingSenderId: "501821296976",
      appId: "1:501821296976:web:e470e5d221d1b1fbb21c55"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let aktualniTym = null;
    let nick = "";

    // Přihlášení / registrace / odhlášení
    function prihlasit() {
      const email = document.getElementById('emailLogin').value;
      const heslo = document.getElementById('passwordLogin').value;
      auth.signInWithEmailAndPassword(email, heslo).catch(err => alert(err.message));
    }
    function registruj() {
      const email = document.getElementById('emailReg').value;
      const heslo = document.getElementById('passwordReg').value;
      auth.createUserWithEmailAndPassword(email, heslo).catch(err => alert(err.message));
    }
    function odhlasit() {
      auth.signOut();
    }

    // Přidání nového běhu
    function pridatBeh() {
      const km = parseFloat(document.getElementById('km').value);
      const cas = parseFloat(document.getElementById('cas').value);
      if (!km || !cas) return alert("Zadej prosím platné km a čas.");
      const tempo = (cas / km).toFixed(2);
      const datum = new Date().toLocaleDateString();
      db.collection("behy").add({ jmeno: nick, km, cas, tempo, datum })
        .then(() => {
          document.getElementById('km').value = '';
          document.getElementById('cas').value = '';
        });
    }

    // Přihlášení do týmu / odchod z týmu
    function pripojSeDoTymu(nazevTymu) {
      db.collection("uzivatele").doc(nick).set({ tym: nazevTymu });
    }
    function opusTym() {
      db.collection("uzivatele").doc(nick).delete();
    }

    // Načtení a zobrazení dat
    function zobrazSekci(jmeno) {
      ['dashboard','mojeBehy','tymMain','tymVytvor','tymPridat'].forEach(id => {
        document.getElementById(id + 'Section').style.display = (id === jmeno) ? 'block' : 'none';
      });
    }

    function zobrazMojeBehy() {
      db.collection("behy").where("jmeno", "==", nick).onSnapshot(snap => {
        let html = "";
        let sumKm = 0, sumCas = 0, sumTempo = 0, count = 0;
        snap.forEach(doc => {
          const z = doc.data();
          html += <div class="card">${z.datum}: ${z.km} km za ${z.cas} min (${z.tempo} min/km)</div>;
          sumKm += z.km; sumCas += z.cas; sumTempo += parseFloat(z.tempo) || 0; count++;
        });
        if (count) {
          const avg = (sumTempo / count).toFixed(2);
          html += <div class="card"><strong>Součet:</strong> ${sumKm} km, ${sumCas} min, průměrné tempo ${avg} min/km</div>;
        }
        document.getElementById('mojeBehy').innerHTML = html;
      });
    }

    function nactiPořadí() {
      db.collection("behy").onSnapshot(snap => {
        const soucty = {};
        snap.forEach(doc => {
          const z = doc.data();
          if (!soucty[z.jmeno]) soucty[z.jmeno] = { km: 0, cas: 0, tempo: 0, pocet: 0 };
          soucty[z.jmeno].km += z.km;
          soucty[z.jmeno].cas += z.cas;
          soucty[z.jmeno].tempo += parseFloat(z.tempo) || 0;
          soucty[z.jmeno].pocet++;
        });
        let i = 1;
        const vykresleni = Object.entries(soucty)
          .sort((a, b) => b[1].km - a[1].km)
          .map(([jmeno, d]) => {
            const prum = (d.tempo / d.pocet).toFixed(2);
            return <div class="card">${i++}. <strong>${jmeno}</strong>: ${d.km} km, ${d.cas} min, ${prum} min/km</div>;
          }).join('');
        document.getElementById('stavUzivatelu').innerHTML = vykresleni;
      });
    }

    function zobrazTymy() {
      db.collection("tymy").onSnapshot(snap => {
        let html = "";
        snap.forEach(doc => {
          const t = doc.data().nazev;
          html += `<div class="card">${t} ` +
                  <button onclick="pripojSeDoTymu('${t}')">Přidat do týmu</button></div>;
        });
        document.getElementById('seznamTymu').innerHTML = html;
      });
    }

    // Reagujeme na změnu stavu přihlášení
    auth.onAuthStateChanged(user => {
      if (user) {
        nick = user.email.split('@')[0];
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'block';
        nactiPořadí();
        zobrazMojeBehy();
        zobrazTymy();
      } else {
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('dashboardSection').style.display = 'none';
      }
    });
  </script>

  <style>
    body { font-family: sans-serif; background: #f8f8f8; color: #222; padding: 20px; max-width: 400px; margin: auto; }
    h1, h2 { text-align: center; color: #ff6600; }
    input, button { font-size: 1.1em; padding: 10px; margin: 8px 0; width: 100%; border-radius: 6px; border: 1px solid #aaa; }
    button { background: #ff6600; color: #fff; font-weight: bold; cursor: pointer; }
    .card { background: #fff; border: 1px solid #ccc; padding: 12px; margin: 8px 0; border-radius: 8px; }
    .hidden { display: none; }
    #sidebar { position: fixed; top: 0; left: 0; width: 0; height: 100%; background: #eee; overflow: hidden; transition: width .3s; }
    #sidebar a { display: block; padding: 12px; color: #333; text-decoration: none; }
    #sidebar a:hover { background: #ddd; }
    #hamburger { position: fixed; top: 15px; left: 15px; font-size: 1.8em; cursor: pointer; }
  </style>
</head>
<body>
  <div id="hamburger" onclick="document.getElementById('sidebar').style.width = document.getElementById('sidebar').style.width === '200px' ? '0' : '200px'">☰</div>
  <div id="sidebar">
    <a href="#" onclick="zobrazSekci('dashboard')">Dashboard</a>
    <a href="#" onclick="zobrazSekci('mojeBehy')">Moje běhy</a>
    <a href="#" onclick="zobrazSekci('tymMain')">Tým</a>
    <a href="#" onclick="odhlasit()">Odhlásit</a>
  </div>

  <h1>Dolní Lhota Run</h1>

  <div id="loginSection">
    <h2>Přihlášení</h2>
    <input id="emailLogin" type="email" placeholder="Email">
    <input id="passwordLogin" type="password" placeholder="Heslo">
    <button onclick="prihlasit()">Přihlásit</button>
    <h2>Registrace</h2>
    <input id="emailReg" type="email" placeholder="Email">
    <input id="passwordReg" type="password" placeholder="Heslo">
    <button onclick="registruj()">Registrovat</button>
  </div>

  <div id="dashboardSection" class="hidden">
    <h2>Zadat nový běh</h2>
    <input id="km" type="number" placeholder="Kolik km?">
    <input id="cas" type="number" placeholder="Čas v minutách">
    <button onclick="pridatBeh()">Přidat běh</button>
    <h2>Pořadí uživatelů</h2>
    <div id="stavUzivatelu"></div>
  </div>

  <div id="mojeBehySection" class="hidden">
    <h2>Moje běhy</h2>
    <div id="mojeBehy"></div>
  </div>

  <div id="tymMainSection" class="hidden">
    <h2>Tým</h2>
    <button onclick="zobrazSekci('tymVytvor')">Vytvořit tým</button>
    <button onclick="zobrazSekci('tymPridat')">Přidat do týmu</button>
  </div>

  <div id="tymVytvorSection" class="hidden">
    <h2>Vytvořit tým</h2>
    <input id="nazevTymu" type="text" placeholder="Název týmu">
    <button onclick="db.collection('tymy').add({nazev: document.getElementById('nazevTymu').value});">Vytvořit</button>
  </div>

  <div id="tymPridatSection" class="hidden">
    <h2>Vyber tým</h2>
    <div id="seznamTymu"></div>
  </div>
</body>
</html>
